<!-- shared-filter.component.html -->
<form [formGroup]="filterForm" *ngIf="filterType">
  <ng-container [ngSwitch]="filterType">
    <ng-container *ngSwitchDefault>
      <mat-form-field [id]="key">
        <mat-label>{{ label }}</mat-label>
        <input
          matInput
          #input
          type="text"
          (input)="onInput($event)"
          [matTooltip]="tooltip"
          matTooltipPosition="after"
          formControlName="textField"
        />
      </mat-form-field>
    </ng-container>

    <ng-container *ngSwitchCase="'dateRange'">
      <mat-form-field
        [matTooltip]="tooltip"
        matTooltipPosition="after"
        [id]="key"
      >
        <mat-label>{{ label }}</mat-label>
        <mat-date-range-input
          formGroupName="dateRangeField"
          [rangePicker]="picker"
        >
          <input
            matStartDate
            (dateChange)="dateChanged($event, 'begin')"
            formControlName="start"
            data-cy="creation-time-begin"
          />
          <input
            matEndDate
            (dateChange)="dateChanged($event, 'end')"
            formControlName="end"
            data-cy="creation-time-end"
          />
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </ng-container>

    <ng-container *ngSwitchCase="'checkbox'">
      <div class="filter-group">
        <mat-label class="filter-title"
          >{{ label | translate: localization }}
          <span *ngIf="shouldShowBadge" class="filter-badge">{{
            badgeCount
          }}</span></mat-label
        >
        <mat-form-field
          *ngIf="showCheckboxSearch"
          appearance="outline"
          class="facet-search"
          floatLabel="always"
        >
          <mat-label>Type to filter</mat-label>
          <input
            matInput
            type="search"
            formControlName="textField"
            placeholder="{{ placeholder }}"
          />
        </mat-form-field>
        <ng-container *ngIf="visibleFacetCounts?.length > 0; else noItems">
          <div class="checkbox-list">
            <mat-checkbox
              *ngFor="let field of visibleFacetCounts; trackBy: trackById"
              [checked]="
                filterForm.get('selectedIds')!.value?.includes(field._id)
              "
              (change)="onToggleCheckbox(field._id, $event.checked)"
            >
              {{ field.label ?? field._id }} ({{ field.count }})
            </mat-checkbox>
          </div>
          <div class="show-more-btn" *ngIf="hasMore">
            <button mat-button (click)="onShowMore()">Show more...</button>
          </div>
        </ng-container>
        <ng-template #noItems>
          <div class="empty-text">No options found</div>
        </ng-template>
      </div>

      <mat-divider />
    </ng-container>

    <ng-container *ngSwitchCase="'multiSelect'">
      <multiselect-filter
        [key]="key"
        [label]="label"
        [tooltip]="tooltip"
        (selectionChange)="onSelectionChange($event)"
        [facetCounts$]="facetCounts$"
        [currentFilter$]="currentFilter$"
      ></multiselect-filter>
    </ng-container>
    <ng-container *ngSwitchCase="'number'">
      <ngx-numeric-range-form-field
        formControlName="numberRange"
        [label]="label"
        [key]="key"
        (numericRangeChanged)="onNumericRangeChange($event)"
      ></ngx-numeric-range-form-field>
    </ng-container>
  </ng-container>
</form>

<!-- Condition Filter Section -->
 <!-- Maybe it should have its own component in the future? -->
<ng-container *ngIf="showConditions">
  <div class="section-container conditions-header">
    <mat-card-title>Conditions</mat-card-title>
    <button
      mat-icon-button
      class="condition-button"
      (click)="addCondition()"
      matTooltip="Add condition"
      data-cy="add-condition-button"
    >
      <mat-icon>add</mat-icon>
    </button>
  </div>
  <mat-accordion
    multi="true"
    *ngIf="conditionConfigs$ | async as conditionConfigs"
  >
    <mat-expansion-panel
      *ngFor="
        let conditionConfig of conditionConfigs;
        let i = index;
        trackBy: trackByCondition
      "
      class="condition-panel"
      [class.disabled]="!conditionConfig.enabled"
    >
      <mat-expansion-panel-header class="custom-panel-header">
        <mat-panel-title>
          <div class="condition-title-section">
            <div class="condition-field-name">
              <mat-icon
                class="cell-icon"
                fontIcon="description"
                #hoverOriginSpan="cdkOverlayOrigin"
                cdkOverlayOrigin
                (mouseenter)="hoverKey = conditionConfig.condition.lhs"
                (mouseleave)="hoverKey = null"
              ></mat-icon>
              <div class="field-name-wrapper">
                <ng-container
                  *ngIf="
                    getHumanName(conditionConfig.condition.lhs);
                    else rawNameOnlyHeader
                  "
                >
                  <div class="primary-name">
                    {{ getHumanName(conditionConfig.condition.lhs) }}
                  </div>
                  <div
                    class="secondary-name"
                    *ngIf="humanNameMap[conditionConfig.condition.lhs]"
                  >
                    {{ conditionConfig.condition.lhs }}
                  </div>
                </ng-container>
                <ng-template #rawNameOnlyHeader>
                  <div class="primary-name" style="font-style: italic">
                    {{ conditionConfig.condition.lhs }}
                  </div>
                </ng-template>
              </div>

              <ng-template
                cdkConnectedOverlay
                [cdkConnectedOverlayOrigin]="hoverOriginSpan"
                [cdkConnectedOverlayOpen]="
                  hoverKey === conditionConfig.condition.lhs
                "
                [cdkConnectedOverlayPositions]="overlayPositions"
              >
                <mat-card class="hover-card">
                  <mat-card-title class="hover-card-title"
                    >Name Details</mat-card-title
                  >
                  <div mat-card-content class="hover-card-content">
                    <ng-container
                      *ngIf="
                        getHumanName(conditionConfig.condition.lhs);
                        else rawNameOnly
                      "
                    >
                      <strong>Human readable name: </strong
                      >{{ getHumanName(conditionConfig.condition.lhs) }}<br />
                      <strong>Metadata key:</strong>
                      {{ conditionConfig.condition.lhs }}
                    </ng-container>
                  </div>
                  <ng-template #rawNameOnly>
                    <strong>Metadata key: </strong
                    ><span style="font-style: italic">{{
                      conditionConfig.condition.lhs
                    }}</span>
                  </ng-template>
                </mat-card>
              </ng-template>
            </div>
            <div class="condition-description">
              <span class="condition-chip">{{
                getConditionDisplayText(conditionConfig.condition, i)
              }}</span>
            </div>
          </div>
        </mat-panel-title>
        <mat-panel-description>
          {{ getConditionDisplayText(conditionConfig.condition, i) }}
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="condition-details">
        <mat-form-field appearance="outline" class="condition-fields">
          <mat-label>Operator</mat-label>
          <mat-select
            [value]="getOperatorUIValue(conditionConfig.condition.relation)"
            (selectionChange)="updateConditionOperator(i, $event.value)"
          >
            <mat-select-trigger>
              <span>
                {{
                  conditionConfig.condition.relation === "GREATER_THAN"
                    ? "is greater than"
                    : conditionConfig.condition.relation === "LESS_THAN"
                      ? "is less than"
                      : getOperatorUIValue(
                            conditionConfig.condition.relation
                          ) === "EQUAL_TO"
                        ? "is equal to"
                        : conditionConfig.condition.relation ===
                            "GREATER_THAN_OR_EQUAL"
                          ? "is greater than or equal to"
                          : conditionConfig.condition.relation ===
                              "LESS_THAN_OR_EQUAL"
                            ? "is less than or equal to"
                            : conditionConfig.condition.relation === "RANGE"
                              ? "is in range"
                              : ""
                }}
                <span class="operator-symbol">
                  {{
                    conditionConfig.condition.relation === "GREATER_THAN"
                      ? "( > )"
                      : conditionConfig.condition.relation === "LESS_THAN"
                        ? "( < )"
                        : getOperatorUIValue(
                              conditionConfig.condition.relation
                            ) === "EQUAL_TO"
                          ? "( = )"
                          : conditionConfig.condition.relation ===
                              "GREATER_THAN_OR_EQUAL"
                            ? "( ≥ )"
                            : conditionConfig.condition.relation ===
                                "LESS_THAN_OR_EQUAL"
                              ? "( ≤ )"
                              : conditionConfig.condition.relation === "RANGE"
                                ? "( <-> )"
                                : ""
                  }}
                </span>
              </span>
            </mat-select-trigger>
            <mat-option
              *ngFor="
                let operator of getAllowedOperators(
                  conditionConfig.condition.lhs
                )
              "
              [value]="operator"
            >
              <ng-container [ngSwitch]="operator">
                <span *ngSwitchCase="'EQUAL_TO'"
                  >is equal to <span class="operator-symbol">( = )</span></span
                >
                <span *ngSwitchCase="'GREATER_THAN'"
                  >is greater than
                  <span class="operator-symbol">( &gt; )</span></span
                >
                <span *ngSwitchCase="'LESS_THAN'"
                  >is less than
                  <span class="operator-symbol">( &lt; )</span></span
                >
                <span *ngSwitchCase="'GREATER_THAN_OR_EQUAL'"
                  >is greater than or equal to
                  <span class="operator-symbol">( ≥ )</span></span
                >
                <span *ngSwitchCase="'LESS_THAN_OR_EQUAL'"
                  >is less than or equal to
                  <span class="operator-symbol">( ≤ )</span></span
                >
                <span *ngSwitchCase="'RANGE'"
                  >is in range
                  <span class="operator-symbol">( &lt;-&gt; )</span></span
                >
              </ng-container>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field
          appearance="outline"
          class="condition-fields"
          *ngIf="
            getOperatorUIValue(conditionConfig.condition.relation) !== 'RANGE'
          "
        >
          <mat-label>Value</mat-label>
          <input
            matInput
            [value]="conditionConfig.condition.rhs"
            (input)="updateConditionValue(i, $event)"
          />
        </mat-form-field>

        <mat-form-field
          appearance="outline"
          class="condition-fields"
          *ngIf="
            getOperatorUIValue(conditionConfig.condition.relation) === 'RANGE'
          "
        >
          <mat-label>Min</mat-label>
          <input
            matInput
            [value]="conditionConfig.condition.rhs?.[0]"
            (input)="updateConditionRangeValue(i, $event, 0)"
            type="number"
          />
        </mat-form-field>
        <mat-form-field
          appearance="outline"
          class="condition-fields"
          *ngIf="
            getOperatorUIValue(conditionConfig.condition.relation) === 'RANGE'
          "
        >
          <mat-label>Max</mat-label>
          <input
            matInput
            [value]="conditionConfig.condition.rhs?.[1]"
            (input)="updateConditionRangeValue(i, $event, 1)"
            type="number"
          />
        </mat-form-field>

        <ng-template [ngIf]="unitsEnabled">
          <mat-form-field appearance="outline" class="condition-fields">
            <mat-label>Unit</mat-label>
            <input
              matInput
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
              [value]="conditionConfig.condition.unit || ''"
              (input)="updateConditionUnit(i, $event)"
              [matAutocomplete]="rhsUnits"
            />
            <mat-autocomplete
              #rhsUnits="matAutocomplete"
              (optionSelected)="updateConditionUnit(i, $event)"
            >
              <mat-option
                *ngFor="let unit of getUnits(conditionConfig.condition.lhs)"
                [value]="unit"
                >{{ unit }}</mat-option
              >
            </mat-autocomplete>
          </mat-form-field>
        </ng-template>

        <div class="condition-actions-section">
          <mat-slide-toggle
            *ngIf="showConditionToggle"
            [checked]="conditionConfig.enabled"
            (change)="toggleConditionEnabled(i, $event.checked)"
            matTooltip="Enable/Disable condition"
            class="condition-toggle"
          >
            {{ conditionConfig.enabled ? "Enabled" : "Disabled" }}
          </mat-slide-toggle>

          <button
            class="condition-remove"
            mat-icon-button
            color="warn"
            (click)="removeCondition(conditionConfig, i)"
            matTooltip="Remove condition"
            data-cy="remove-condition-button"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</ng-container>
