<mat-card>
  <mat-card-header class="section-container filters-header">
    <mat-card-title>Filters</mat-card-title>
    <div class="section-container" data-cy="more-filters-button">
      <button
        mat-icon-button
        class="settings-button"
        (click)="showDatasetsFilterSettingsDialog()"
        matTooltip="Filter settings"
      >
        <mat-icon>settings</mat-icon>
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <ng-container *ngFor="let filter of filtersList">
      <shared-filter
        *ngIf="filter.enabled"
        [key]="filter.key"
        [label]="filter.label"
        [clear]="clearSearchBar"
        [tooltip]="filter.description"
        [filterType]="filter.type"
        [prefilled]="activeFilters[filter.key] || null"
        [currentFilter$]="getFilterByKey$(filter.key)"
        [facetCounts$]="getFilterFacetCounts$(filter.key)"
        (textChange)="setFilter(filter.key, $event)"
        (dateRangeChange)="setDateFilter(filter.key, $event)"
        (selectionChange)="selectionChange($event)"
        (checkBoxChange)="setFilter(filter.key, $event)"
        (numericRangeChange)="numericRangeChange(filter.key, $event)"
      ></shared-filter>
    </ng-container>
    <div
      class="section-container scientific-conditions"
      *ngIf="appConfig.scienceSearchEnabled"
      data-cy="scientific-condition-filter-list"
    >
      <div class="section-container conditions-header">
        <mat-card-title>Conditions</mat-card-title>
        <button
          mat-icon-button
          class="condition-button"
          (click)="addCondition()"
          matTooltip="Add condition"
          data-cy="add-condition-button"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
      <mat-accordion
        multi="true"
        *ngIf="conditionConfigs$ | async as conditionConfigs"
      >
        <mat-expansion-panel
          *ngFor="
            let conditionConfig of conditionConfigs;
            let i = index;
            trackBy: trackByCondition
          "
          class="condition-panel"
          [class.disabled]="!conditionConfig.enabled"
        >
          <mat-expansion-panel-header class="custom-panel-header">
            <mat-panel-title>
              <div class="condition-title-section">
                <div class="condition-field-name">
                  <mat-icon
                    class="cell-icon"
                    fontIcon="description"
                    #hoverOriginSpan="cdkOverlayOrigin"
                    cdkOverlayOrigin
                    (mouseenter)="hoverKey = conditionConfig.condition.lhs"
                    (mouseleave)="hoverKey = null"
                  ></mat-icon>
                  <div class="field-name-wrapper">
                    <div class="human-name">
                      {{ getHumanName(conditionConfig.condition.lhs) }}
                    </div>
                    <div
                      class="metadata-name"
                      *ngIf="humanNameMap[conditionConfig.condition.lhs]"
                    >
                      {{ conditionConfig.condition.lhs }}
                    </div>
                  </div>

                  <!-- Hover overlay -->
                  <ng-template
                    cdkConnectedOverlay
                    [cdkConnectedOverlayOrigin]="hoverOriginSpan"
                    [cdkConnectedOverlayOpen]="
                      hoverKey === conditionConfig.condition.lhs
                    "
                    [cdkConnectedOverlayPositions]="overlayPositions"
                  >
                    <mat-card class="hover-card">
                      <mat-card-title class="hover-card-title">
                        Name Details
                      </mat-card-title>
                      <div mat-card-content class="hover-card-content">
                        <ng-container
                          *ngIf="
                            getHumanName(conditionConfig.condition.lhs);
                            else rawNameOnly
                          "
                        >
                          <strong>Human readable name: </strong>
                          {{ getHumanName(conditionConfig.condition.lhs) }}
                          <br />
                          <strong>Metadata name:</strong>
                          {{ conditionConfig.condition.lhs }}
                        </ng-container>
                      </div>
                      <ng-template #rawNameOnly>
                        <strong>Metadata name:</strong>
                        {{ conditionConfig.condition.lhs }}
                      </ng-template>
                    </mat-card>
                  </ng-template>
                </div>
                <div class="condition-description">
                  <span class="condition-chip">{{
                    getConditionDisplayText(conditionConfig.condition)
                  }}</span>
                </div>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              {{ getConditionDisplayText(conditionConfig.condition) }}
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="condition-details">
            <mat-form-field appearance="outline" class="condition-fields">
              <mat-label>Operator</mat-label>
              <mat-select
                [value]="getOperatorUIValue(conditionConfig.condition.relation)"
                (selectionChange)="updateConditionOperator(i, $event.value)"
              >
                <mat-select-trigger>
                  <span>
                    {{
                      conditionConfig.condition.relation === "GREATER_THAN"
                        ? "is greater than"
                        : conditionConfig.condition.relation === "LESS_THAN"
                          ? "is less than"
                          : getOperatorUIValue(
                                conditionConfig.condition.relation
                              ) === "EQUAL_TO"
                            ? "is equal to"
                            : conditionConfig.condition.relation ===
                                "GREATER_THAN_OR_EQUAL"
                              ? "is greater than or equal to"
                              : conditionConfig.condition.relation ===
                                  "LESS_THAN_OR_EQUAL"
                                ? "is less than or equal to"
                                : conditionConfig.condition.relation === "RANGE"
                                  ? "is in range"
                                  : ""
                    }}
                    <span class="operator-symbol">
                      {{
                        conditionConfig.condition.relation === "GREATER_THAN"
                          ? "( > )"
                          : conditionConfig.condition.relation === "LESS_THAN"
                            ? "( < )"
                            : getOperatorUIValue(
                                  conditionConfig.condition.relation
                                ) === "EQUAL_TO"
                              ? "( = )"
                              : conditionConfig.condition.relation ===
                                  "GREATER_THAN_OR_EQUAL"
                                ? "( ≥ )"
                                : conditionConfig.condition.relation ===
                                    "LESS_THAN_OR_EQUAL"
                                  ? "( ≤ )"
                                  : conditionConfig.condition.relation ===
                                      "RANGE"
                                    ? "( <-> )"
                                    : ""
                      }}
                    </span>
                  </span>
                </mat-select-trigger>
                <mat-option
                  *ngFor="
                    let operator of getAllowedOperators(
                      conditionConfig.condition.lhs
                    )
                  "
                  [value]="operator"
                >
                  <ng-container [ngSwitch]="operator">
                    <span *ngSwitchCase="'EQUAL_TO'"
                      >is equal to
                      <span class="operator-symbol">( = )</span></span
                    >
                    <span *ngSwitchCase="'GREATER_THAN'"
                      >is greater than
                      <span class="operator-symbol">( &gt; )</span></span
                    >
                    <span *ngSwitchCase="'LESS_THAN'"
                      >is less than
                      <span class="operator-symbol">( &lt; )</span></span
                    >
                    <span *ngSwitchCase="'GREATER_THAN_OR_EQUAL'"
                      >is greater than or equal to
                      <span class="operator-symbol">( ≥ )</span></span
                    >
                    <span *ngSwitchCase="'LESS_THAN_OR_EQUAL'"
                      >is less than or equal to
                      <span class="operator-symbol">( ≤ )</span></span
                    >
                    <span *ngSwitchCase="'RANGE'"
                      >is in range
                      <span class="operator-symbol">( &lt;-&gt; )</span></span
                    >
                  </ng-container>
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="condition-fields"
              *ngIf="
                getOperatorUIValue(conditionConfig.condition.relation) !==
                'RANGE'
              "
            >
              <mat-label>Value</mat-label>
              <input
                matInput
                [value]="conditionConfig.condition.rhs"
                (input)="updateConditionValue(i, $event)"
              />
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="condition-fields"
              *ngIf="
                getOperatorUIValue(conditionConfig.condition.relation) ===
                'RANGE'
              "
            >
              <mat-label>Min</mat-label>
              <input
                matInput
                [value]="conditionConfig.condition.rhs?.[0]"
                (input)="updateConditionRangeValue(i, $event, 0)"
                type="number"
              />
            </mat-form-field>
            <mat-form-field
              appearance="outline"
              class="condition-fields"
              *ngIf="
                getOperatorUIValue(conditionConfig.condition.relation) ===
                'RANGE'
              "
            >
              <mat-label>Max</mat-label>
              <input
                matInput
                [value]="conditionConfig.condition.rhs?.[1]"
                (input)="updateConditionRangeValue(i, $event, 1)"
                type="number"
              />
            </mat-form-field>

            <ng-template [ngIf]="appConfig.scienceSearchUnitsEnabled">
              <mat-form-field appearance="outline" class="condition-fields">
                <mat-label>Unit</mat-label>
                <input
                  matInput
                  autocomplete="off"
                  autocorrect="off"
                  autocapitalize="off"
                  spellcheck="false"
                  [value]="conditionConfig.condition.unit || ''"
                  (input)="updateConditionUnit(i, $event)"
                  [matAutocomplete]="rhsUnits"
                />
                <mat-autocomplete
                  #rhsUnits="matAutocomplete"
                  (optionSelected)="updateConditionUnit(i, $event)"
                >
                  <mat-option
                    *ngFor="let unit of getUnits(conditionConfig.condition.lhs)"
                    [value]="unit"
                  >
                    {{ unit }}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </ng-template>

            <div class="condition-actions-section">
              <mat-slide-toggle
                [checked]="conditionConfig.enabled"
                (change)="toggleConditionEnabled(i, $event.checked)"
                matTooltip="Enable/Disable condition"
                class="condition-toggle"
              >
                {{ conditionConfig.enabled ? "Enabled" : "Disabled" }}
              </mat-slide-toggle>

              <button
                class="condition-remove"
                mat-icon-button
                color="warn"
                (click)="removeCondition(conditionConfig, i)"
                matTooltip="Remove condition"
                data-cy="remove-condition-button"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <div class="section-container">
      <button
        [disabled]="(hasAppliedFilters$ | async) === false"
        mat-raised-button
        color="secondary"
        class="datasets-filters-clear-all-button"
        (click)="reset()"
      >
        <mat-icon>undo</mat-icon>
        Clear
      </button>
      <button
        mat-raised-button
        color="primary"
        class="datasets-filters-search-button"
        (click)="applyFilters()"
      >
        <mat-icon>search</mat-icon>
        Apply
      </button>
    </div>
  </mat-card-content>
</mat-card>
